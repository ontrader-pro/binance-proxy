<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>OnTrader Real Futures Index</title>
  <style>
    html, body { margin:0; padding:0; background: #101729; color: #fff; font-family: sans-serif; height: 100%; }
    h1 { text-align: center; color: #25f0ff; }
    #panel { padding: 0 10px; overflow-y: auto; }
    .loading { text-align: center; padding: 40px; color: #aaa; }
    table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 0.93rem;}
    th, td { border: 1px solid #333; padding: 5px; text-align: center;}
    thead { background: #1f2a44; color: #25f0ff; }
    .high { color: limegreen; }
    .low { color: red; }
    .mid { color: orange; }
    #error-box { color: #f55; text-align: center; margin: 8px 0;}
  </style>
</head>
<body>
<h1>OnTrader Real Futures Index</h1>
<div id="panel"><div class="loading">Cargando datos reales‚Ä¶</div></div>
<div id="error-box"></div>
<script>
const STABLES = ["USDT","USDC","BUSD","TUSD","FDUSD","DAI","PAX","GUSD"];
const BASE_URL = "https://fapi.binance.com";
const SYMBOL_LIMIT = 100;
const REFRESH_MS = 120000; // 2 min

let cache = {}, prevScores = {};

function isStable(symbol) {
  return STABLES.some(st => symbol.endsWith(st));
}

function calcEMA(prices, period=28) {
  const k = 2/(period+1);
  let ema = prices[0];
  for(let i=1;i<prices.length;i++) ema = prices[i]*k + ema*(1-k);
  return ema;
}
function calcRSI(prices, period=14) {
  let gains=0, losses=0;
  for(let i=1;i<prices.length;i++) {
    const d = prices[i]-prices[i-1];
    if(d>0) gains+=d; else losses-=d;
  }
  if (gains + losses === 0) return 50;
  const avgGain = gains/period, avgLoss = losses/period || 1e-8;
  const rs = avgGain/avgLoss;
  return 100-(100/(1+rs));
}

async function fetchJson(url) {
  const r = await fetch(url);
  if(!r.ok) throw new Error("Status "+r.status);
  return r.json();
}

async function getTopSymbols() {
  const data = await fetchJson(BASE_URL + "/fapi/v1/ticker/24hr");
  return data.filter(d => !isStable(d.symbol) && d.contractType==="PERPETUAL")
    .sort((a,b)=>parseFloat(b.openInterest)-parseFloat(a.openInterest))
    .slice(0, SYMBOL_LIMIT)
    .map(d => d.symbol);
}
async function getKlines(symbol, interval, limit) {
  const url = `${BASE_URL}/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const arr = await fetchJson(url);
  return arr.map(a => ({
    time:+a[0], open:+a[1], high:+a[2], low:+a[3], close:+a[4], volume:+a[5]
  }));
}
function getSundayMinMax(daily) {
  for(let i=daily.length-1;i>=0;i--) {
    const dt = new Date(daily[i].time);
    if(dt.getUTCDay()===0) return {min:daily[i].low, max:daily[i].high};
  }
  return {min:daily[0].low, max:daily[0].high};
}

async function fetchAndCalc() {
  panel.innerHTML = `<div class="loading">Cargando datos reales‚Ä¶</div>`;
  errorBox.textContent = '';
  let symbols;
  try {
    symbols = await getTopSymbols();
  } catch (e) {
    errorBox.textContent = 'Error: no se pudo descargar s√≠mbolos de Binance.';
    return;
  }
  const results = [];
  for(const symbol of symbols) {
    try {
      // Velas diarias
      const daily = await getKlines(symbol, "1d", 14);
      const {min: minSun, max: maxSun} = getSundayMinMax(daily);
      // Velas 15m, 5m, 4m
      const v15 = await getKlines(symbol, "15m", 40);
      const v5 = await getKlines(symbol, "5m", 40);
      const v4 = await getKlines(symbol, "4m", 40);

      const close15 = v15.map(v=>v.close);
      const close5 = v5.map(v=>v.close);
      const close4 = v4.map(v=>v.close);

      const ema15 = calcEMA(close15.slice(-28), 28);
      const rsi15 = calcRSI(close15.slice(-15), 14);

      const ema5 = calcEMA(close5.slice(-28), 28);
      const rsi5 = calcRSI(close5.slice(-15), 14);

      const rsi4 = calcRSI(close4.slice(-15), 14);

      const lastPrice = close15[close15.length-1];

      let score = 1;
      if(lastPrice>minSun) score+=3;
      if(lastPrice>maxSun) score+=2;
      if(rsi15>50 && lastPrice>ema15) score+=2;
      if(rsi15<50 && lastPrice<ema15) score-=2;
      if(rsi5>70 && lastPrice>ema5) score+=1;
      if(rsi5<30 && lastPrice<ema5) score-=1;
      if(rsi4<15) score+=0.5;
      if(rsi4>85) score-=0.5;
      score = Math.max(1, Math.min(10, score));

      let phase = '';
      if(score<=3.0) phase = 'üî¥ Oversold';
      else if(score<4.9) phase = 'üî¥ Bearish Incline';
      else if(score<6.0) phase = 'üü† Accumulation';
      else if(score<8.1) phase = 'üü° Bullish Incline';
      else phase = 'üü¢ Overbought';

      let prev = cache[symbol]?.score || score;
      results.push({symbol, lastPrice, phase, score, prev});
      cache[symbol] = {score}; // guardar para score previo
    } catch(e) {
      continue;
    }
  }

  // Top 10 Alcistas
  const topBull = results.slice().sort((a,b)=>b.score-a.score).slice(0,10);
  // Top 10 Bajistas
  const topBear = results.slice().sort((a,b)=>a.score-b.score).slice(0,10);
  // Top subidas score
  const topRise = results.filter(r=>r.score>r.prev).sort((a,b)=>(b.score-b.prev)-(a.score-a.prev)).slice(0,10);
  // Top ca√≠das score
  const topFall = results.filter(r=>r.score<r.prev).sort((a,b)=>(a.score-a.prev)-(b.score-b.prev)).slice(0,10);

  panel.innerHTML = `
    <h2>Top 10 Alcistas</h2>${makeTable(topBull)}
    <h2>Top 10 Bajistas</h2>${makeTable(topBear)}
    <h2>Top 10 Cambios al Alza</h2>${makeTable(topRise)}
    <h2>Top 10 Cambios a la Baja</h2>${makeTable(topFall)}
    <div class="loading">Actualizado: ${new Date().toLocaleTimeString()}</div>
  `;
  // Guardar para la pr√≥xima sesi√≥n
  localStorage.setItem('ontraderScores', JSON.stringify(cache));
}

function makeTable(arr) {
  let html = '<table><thead><tr><th>S√≠mbolo</th><th>Precio</th><th>Fase</th><th>Score</th><th>Prev Score</th></tr></thead><tbody>';
  for(const d of arr) html+=`<tr>
    <td>${d.symbol}</td>
    <td>${(+d.lastPrice).toFixed(6)}</td>
    <td>${d.phase}</td>
    <td class="${d.score>=8?'high':d.score<=3?'low':'mid'}">${d.score.toFixed(2)}</td>
    <td>${d.prev.toFixed(2)}</td>
  </tr>`;
  return html+'</tbody></table>';
}

window.onload = ()=>{
  try { cache = JSON.parse(localStorage.getItem('ontraderScores')) || {}; } catch {}
  fetchAndCalc();
  setInterval(fetchAndCalc, REFRESH_MS);
};
</script>
</body>
</html>
