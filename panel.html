<!-- Panel OnTrader Index Real (100% client-side, proxy Vercel, solo navegador) -->
<div id="ontrader-panel"><div style="text-align:center;color:#aaa;padding:40px;">Cargando datos de Binanceâ€¦</div></div>
<div id="ontrader-error" style="color:#f55;text-align:center;"></div>
<script>
const STABLES = ["USDT","USDC","BUSD","TUSD","FDUSD","DAI","PAX","GUSD"];
const PROXY_BASE = "https://binance-proxy-swart.vercel.app/api/binance-proxy?url=";
const BINANCE_API = "https://fapi.binance.com";
const SYMBOL_LIMIT = 100, REFRESH_MS = 120000;
let cache = {}, prevScores = {};

function isStable(symbol) {
  return STABLES.some(st => symbol.endsWith(st));
}
async function fetchJson(url) {
  const resp = await fetch(PROXY_BASE + encodeURIComponent(url));
  if(!resp.ok) throw new Error("Status "+resp.status);
  return resp.json();
}
async function getTopSymbols() {
  const data = await fetchJson(BINANCE_API + "/fapi/v1/ticker/24hr");
  return data.filter(d => !isStable(d.symbol) && d.contractType==="PERPETUAL")
    .sort((a,b)=>parseFloat(b.openInterest)-parseFloat(a.openInterest))
    .slice(0, SYMBOL_LIMIT)
    .map(d => d.symbol);
}
async function getKlines(symbol, interval, limit) {
  const url = `${BINANCE_API}/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const arr = await fetchJson(url);
  return arr.map(a => ({
    time:+a[0], open:+a[1], high:+a[2], low:+a[3], close:+a[4], volume:+a[5]
  }));
}
function getSundayMinMax(daily) {
  for(let i=daily.length-1;i>=0;i--) {
    const dt = new Date(daily[i].time);
    if(dt.getUTCDay()===0) return {min:daily[i].low, max:daily[i].high};
  }
  return {min:daily[0].low, max:daily[0].high};
}
function calcEMA(prices, period=28) {
  const k = 2/(period+1); let ema = prices[0];
  for(let i=1;i<prices.length;i++) ema = prices[i]*k + ema*(1-k);
  return ema;
}
function calcRSI(prices, period=14) {
  let gains=0, losses=0;
  for(let i=1;i<prices.length;i++) {
    const d = prices[i]-prices[i-1];
    if(d>0) gains+=d; else losses-=d;
  }
  if(gains+losses===0) return 50;
  const avgGain = gains/period, avgLoss = losses/period || 1e-8;
  const rs = avgGain/avgLoss;
  return 100-(100/(1+rs));
}
function calcScorePhases({lastPrice,minSun,maxSun,ema15,rsi15,ema5,rsi5,rsi4}) {
  let score = 1;
  if(lastPrice>minSun) score+=3;
  if(lastPrice>maxSun) score+=2;
  if(rsi15>50 && lastPrice>ema15) score+=2;
  if(rsi15<50 && lastPrice<ema15) score-=2;
  if(rsi5>70 && lastPrice>ema5) score+=1;
  if(rsi5<30 && lastPrice<ema5) score-=1;
  if(rsi4<15) score+=0.5;
  if(rsi4>85) score-=0.5;
  score = Math.max(1, Math.min(10, score));
  let phase = '';
  if(score<=3.0) phase = 'ðŸ”´ Oversold';
  else if(score<4.9) phase = 'ðŸ”´ Bearish Incline';
  else if(score<6.0) phase = 'ðŸŸ  Accumulation';
  else if(score<8.1) phase = 'ðŸŸ¡ Bullish Incline';
  else phase = 'ðŸŸ¢ Overbought';
  return { score, phase };
}

async function fetchAndCalc() {
  const panel = document.getElementById("ontrader-panel");
  const errorBox = document.getElementById("ontrader-error");
  panel.innerHTML = `<div style="text-align:center;color:#aaa;padding:40px;">Cargando datos de Binanceâ€¦</div>`;
  errorBox.textContent = "";
  let symbols;
  try {
    symbols = await getTopSymbols();
  } catch (e) {
    errorBox.textContent = "Error: no se pudo descargar sÃ­mbolos de Binance.";
    return;
  }
  const results = [];
  for(const symbol of symbols) {
    try {
      const daily = await getKlines(symbol, "1d", 14);
      const {min:minSun,max:maxSun} = getSundayMinMax(daily);
      const v15 = await getKlines(symbol, "15m", 40);
      const v5 = await getKlines(symbol, "5m", 40);
      const v4 = await getKlines(symbol, "4m", 40);

      const close15 = v15.map(v=>v.close);
      const close5 = v5.map(v=>v.close);
      const close4 = v4.map(v=>v.close);

      const ema15 = calcEMA(close15.slice(-28), 28);
      const rsi15 = calcRSI(close15.slice(-15), 14);
      const ema5 = calcEMA(close5.slice(-28), 28);
      const rsi5 = calcRSI(close5.slice(-15), 14);
      const rsi4 = calcRSI(close4.slice(-15), 14);
      const lastPrice = close15[close15.length-1];

      const {score,phase} = calcScorePhases({lastPrice,minSun,maxSun,ema15,rsi15,ema5,rsi5,rsi4});
      let prev = cache[symbol]?.score || score;
      results.push({symbol, lastPrice, phase, score, prev});
      cache[symbol] = {score};
    } catch(e) { continue; }
  }

  // Top 10 Alcistas/Bajistas
  const topBull = results.slice().sort((a,b)=>b.score-a.score).slice(0,10);
  const topBear = results.slice().sort((a,b)=>a.score-b.score).slice(0,10);
  // Top subidas score
  const topRise = results.filter(r=>r.score>r.prev).sort((a,b)=>(b.score-b.prev)-(a.score-a.prev)).slice(0,10);
  // Top caÃ­das score
  const topFall = results.filter(r=>r.score<r.prev).sort((a,b)=>(a.score-a.prev)-(b.score-b.prev)).slice(0,10);

  panel.innerHTML = `
    <h3 style="color:#25f0ff">Top 10 Alcistas</h3>${makeTable(topBull)}
    <h3 style="color:#25f0ff">Top 10 Bajistas</h3>${makeTable(topBear)}
    <h3 style="color:#25f0ff">Top 10 Cambios al Alza</h3>${makeTable(topRise)}
    <h3 style="color:#25f0ff">Top 10 Cambios a la Baja</h3>${makeTable(topFall)}
    <div style="text-align:center;color:#888;">Actualizado: ${new Date().toLocaleTimeString()}</div>
  `;
  try { localStorage.setItem('ontraderScores', JSON.stringify(cache)); } catch {}
}
function makeTable(arr) {
  let html = '<table style="width:100%;border-collapse:collapse;margin:8px 0;font-size:0.93rem;"><thead><tr><th>SÃ­mbolo</th><th>Precio</th><th>Fase</th><th>Score</th><th>Prev Score</th></tr></thead><tbody>';
  for(const d of arr) html+=`<tr>
    <td>${d.symbol}</td>
    <td>${(+d.lastPrice).toFixed(6)}</td>
    <td>${d.phase}</td>
    <td style="color:${d.score>=8?'limegreen':d.score<=3?'red':'orange'};">${d.score.toFixed(2)}</td>
    <td>${d.prev.toFixed(2)}</td>
  </tr>`;
  return html+'</tbody></table>';
}

try { cache = JSON.parse(localStorage.getItem('ontraderScores')) || {}; } catch {}
fetchAndCalc();
setInterval(fetchAndCalc, REFRESH_MS);
</script>
